<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="../../res/layui/css/layui.css" media="all">
		<link rel="stylesheet" href="../../res/css/common/font-awesome.min.css" media="all">
		<link rel="stylesheet" href="../../res/layui-config/css/app.css" media="all">
		<title>药品管理</title>
    </script>
	</head>
	<body>
		<div class="kit-table">
		    <form class="layui-form" lay-filter="kit-search-form">
				<!-- 左上角的两个按钮 -->
		        <div class="kit-table-header">
		            <div class="kit-search-btns">
		                <a href="javascript:;" data-action="add" class="layui-btn layui-btn-sm"><i class="layui-icon">&#xe608;</i> 新增</a>
		                <a href="javascript:;" data-action="del-bulk" class="layui-btn layui-btn-sm layui-btn-danger"><i class="layui-icon">&#xe640;</i> 批量删除</a>
		            </div>
		            <div class="kit-search-inputs">
		                <div class="kit-search-keyword">
		                    <input type="text" class="layui-input" name="keyword" placeholder="搜索关键字.." />
		                    <button lay-submit lay-filter="search"><i class="layui-icon">&#xe615;</i></button>
		                </div>
		                <div class="kit-search-more" id="kit-search-more">更多筛选<i class="layui-icon">&#xe61a;</i></div>
		            </div>
		        </div>
				<!-- 搜索扩展工具条 -->
		        <div class="kit-search-mored layui-anim layui-anim-upbit">
		            <div class="kit-search-body">
		                <div class="layui-form-item">
		                    <label class="layui-form-label">输入框</label>
		                    <div class="layui-input-block">
		                        <input type="text" name="title" placeholder="请输入标题" autocomplete="off" class="layui-input">
		                    </div>
		                </div>
		                <div class="layui-form-item">
		                    <div class="layui-inline">
		                        <label class="layui-form-label">验证手机</label>
		                        <div class="layui-input-inline">
		                            <input type="tel" name="phone" autocomplete="off" class="layui-input">
		                        </div>
		                    </div>
		                    <div class="layui-inline">
		                        <label class="layui-form-label">验证邮箱</label>
		                        <div class="layui-input-inline">
		                            <input type="text" name="email" autocomplete="off" class="layui-input">
		                        </div>
		                    </div>
		                </div>
		                <div class="layui-form-item">
		                    <div class="layui-inline">
		                        <label class="layui-form-label">范围</label>
		                        <div class="layui-input-inline" style="width: 100px;">
		                            <input type="text" name="price_min" placeholder="￥" autocomplete="off" class="layui-input">
		                        </div>
		                        <div class="layui-form-mid">-</div>
		                        <div class="layui-input-inline" style="width: 100px;">
		                            <input type="text" name="price_max" placeholder="￥" autocomplete="off" class="layui-input">
		                        </div>
		                    </div>
		                </div>
		                <div class="layui-form-item">
		                    <label class="layui-form-label">单行选择框</label>
		                    <div class="layui-input-block">
		                        <select name="interest" lay-filter="aihao">
		                            <option value=""></option>
		                            <option value="0">写作</option>
		                            <option value="1" selected="">阅读</option>
		                            <option value="2">游戏</option>
		                            <option value="3">音乐</option>
		                            <option value="4">旅行</option>
		                          </select>
		                    </div>
		                </div>
		            </div>
		            <div class="kit-search-footer">
		                <button type="reset" class="layui-btn layui-btn-sm layui-btn-primary kit-btn">重置</button>
		                <button lay-submit lay-filter="search" class="layui-btn layui-btn-sm kit-btn">确定</button>
		            </div>
		        </div>
		    </form>
				
			<!-- 操作按钮 -->
		    <div class="kit-table-body">
		        <table id="demo" lay-filter="demo"></table>
		        <script type="text/html" id="barDemo">
		            <a class="layui-btn layui-btn-xs" lay-event="detail">查看</a>
		            <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
		            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
		        </script>
		    </div>
		</div>
		
		<!-- 修改页面 -->
		<script type="text/html" id="edit-tpl">
		    <div style="margin:10px">
		        <form class="layui-form" action="" lay-filter="form-edit">
		            <input type="hidden" name="drugId" value="{{d.rowdata.drugId}}" />
		            <div class="layui-form-item">
		                <label class="layui-form-label">名称</label>
		                <div class="layui-input-block">
		                    <input type="text" name="drugName" required lay-verify="required" value="{{d.rowdata.drugName}}" placeholder="请输入标题" autocomplete="off" class="layui-input">
		                </div>
		            </div>
		            <div class="layui-form-item">
		                <label class="layui-form-label">类型</label>
		                <div class="layui-input-block">
		                    <select name="dtId" lay-verify="required">
		                      <option value=""></option>
		                      {{# layui.each(d.types,function(index,item){ }}                      
		                      {{# if(item.dtId===d.rowdata.dtId){}}
		                      <option value="{{item.dtId}}" selected>{{item.dtName}}</option>
		                      {{#}else{}}
		                      <option value="{{item.dtId}}">{{item.dtName}}</option>
		                      {{#};}}
		                      {{# }); }}
		                    </select>
		                </div>
		            </div>
					<div class="layui-form-item">
		                <label class="layui-form-label">单位</label>
		                <div class="layui-input-block">
		                    <input type="text" name="drugUnit" required lay-verify="required" value="{{d.rowdata.drugUnit}}" placeholder="请输入标题" autocomplete="off" class="layui-input">
		                </div>
		            </div>
					<div class="layui-form-item">
		                <label class="layui-form-label">属性</label>
		                <div class="layui-input-block">
		                    {{# var otc = d.rowdata.drugProp == 0?'checked':'';}} {{# var rx = d.rowdata.drugProp == 1?'checked':'';}}
		                    <input type="radio" name="drugProp" value="{{d.rowdata.drugProp}}" title="处方药" {otc}} />
		                    <input type="radio" name="drugProp" value="{{d.rowdata.drugProp}}" title="非处方药" {{rx}} />
		                </div>
		            </div>
		            <div class="layui-form-item">
		                <label class="layui-form-label">价格</label>
		                <div class="layui-input-block">
		                    <input type="number" name="drugPrice" required lay-verify="required" maxlength="3" value="{{d.rowdata.drugPrice}}" placeholder="请输入认购数额（整数）" autocomplete="off" class="layui-input" onKeyUp="this.value=this.value.replace(/[^\.\d]/g,'');this.value=this.value.replace('.','');">
		                </div>
		            </div>
					<div class="layui-upload">
                		<label class="layui-form-label">头像:</label>
                		<div class="layui-upload layui-input-block">
                    		<input type="hidden" name="drugPictrue" value="{{d.rowdata.drugPictrue}}"/>
                    		<button type="button" class="layui-btn layui-btn-primary" id="fileBtn"><i class="layui-icon">&#xe67c;</i>选择文件</button>
                   	 		<button type="button" class="layui-btn layui-btn-warm" id="uploadBtn">开始上传</button>
                		</div>
            		</div>
					
		            <div class="layui-form-item" style="display:none;">
		                <div class="layui-input-block">
		                    <button class="layui-btn" lay-submit lay-filter="formEdit">立即提交</button>
		                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
		                </div>
		            </div>
		        </form>
		    </div>
		</script>
		<script src="../../res/js/common/jquery-1.11.2.min.js"></script>
		<script src="../../res/layui/layui.all.js"></script>
		<!-- 显示表格 -->
		<script>
		    layui.use(['table','upload'], function() {
		        var table = layui.table,
		            $ = layui.jquery,
		            layer = layui.layer,
		            form = layui.form,
		            laytpl = layui.laytpl;
		        var upload = layui.upload;
		        var tableIns = table.render({
		            elem: '#demo',
		            height: 'full', //容器高度
		            url: '../../drug/showList.action',
		            page: true,
		            id: 'demo',
		            cols: [
		                [{
		                    checkbox: true,
		                    fixed: true
		                }, {
		                    field: 'drugId',
		                    title: 'ID',
		                    width: 220
		                }, {
		                    field: 'drugName',
		                    title: '药名',
		                    width: 120
		                }, {
		                    field: 'dtName',
		                    title: '类型',
		                    width: 80
		                }, {
		                    field: 'drugUnit',
		                    title: '单位',
		                    width: 80
		                }, {
		                    field: 'drugProp',
		                    title: '属性',
		                    width: 80
		                }, {
		                    field: 'drugPictrue',
		                    title: '图片',
		                    width: 60,
		                    templet:'<div><img style="height:100%;height:30px;" src="../../{{ d.drugPictrue}}"></div>'
		                }, {
		                    field: 'drugPrice',
		                    title: '价格（元）',
		                    width: 150,
		                    sort: true
		                }, {
		                    fixed: 'right',
		                    title: '操作',
		                    width: 180,
		                    align: 'center',
		                    toolbar: '#barDemo'
		                }]
		            ],
		            done: function(res, curr, count) {
		                //如果是异步请求数据方式，res即为你接口返回的信息。
		                //如果是直接赋值的方式，res即为：{data: [], count: 99} data为当前页数据、count为数据总长度
		                // console.log(res);
		                // //得到当前页码
		                // console.log(curr);
		                // //得到数据总量
		                // console.log(count);
		                $("[data-field = 'drugProp']").children().each(function(){
						    if($(this).text() == '1'){
						    	$(this).text("处方药");
						    } else if ($(this).text() == '0') {
						    	$(this).text("非处方药");
						    }
					  	});
		                /* $("[data-field = 'drugPictrue']").children().each(function(){
						    if($(this).text() == 'null'||$(this).text() == ''){
						    	$(this).text("暂无");
						    }
					  	}); */
		            },
		            loading: true,
		            //method: 'post'
		        });
						//城市及角色
		        var staticData = null;
		        $.ajax({ url:"../../drugType/showList.action",
                    type:'post',//method请求方式，get或者post
                    cache: false,//同步
                    dataType:'json',//预期服务器返回的数据类型
                    success:function(mes){//res为相应体,function为回调函数
                    	staticData = mes;
                    }
                 });
		        //监听搜索表单提交
		        form.on('submit(search)', function(data) {
		            console.log(data.field);
		            layer.msg(JSON.stringify(data.field));
		            //带条件查询
		            tableIns.reload({
		                where: data.field
		            });
		            return false;
		        });
		        //监听工具条
		        table.on('tool(demo)', function(obj) { //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
		            var data = obj.data; //获得当前行数据
		            var layEvent = obj.event; //获得 lay-event 对应的值
		            var tr = obj.tr; //获得当前行 tr 的DOM对象
		
		            if (layEvent === 'detail') { //查看
		                console.log(table.checkStatus('demo'));
		            } else if (layEvent === 'del') { //删除
		                layer.confirm('真的删除行么', function(index) {
		                    //obj.del(); //删除对应行（tr）的DOM结构
		                    $.ajax({ url:"../../drug/addDrug.action",
		                        type:'post',//method请求方式，get或者post
		                        cache: false,//同步
		                        dataType:'json',//预期服务器返回的数据类型
		                        data:JSON.stringify({"drugId":data.drugId,"isva":"0"}),//表格数据序列化
		                        contentType: "application/json; charset=utf-8",
		                        success:function(mes){//res为相应体,function为回调函数
		                        	$(".layui-laypage-btn")[0].click();//当前表格刷新
			                        if(mes.status==1){ 
			                        	layer.msg(mes.msg,{icon:1});
			                        } else {
			                        	layer.msg(mes.msg,{icon:5});
			                        }
		                        },
		                       	error:function(){layer.alert('操作失败！！！',{icon:5});}
			                 });
		                    layer.close(index);
		                    //向服务端发送删除指令
		                });
		            } else if (layEvent === 'edit') { //编辑
		                var d = {
		                	rowdata: data,
		                    types: staticData.types
		                };
		                laytpl($('#edit-tpl').html()).render(d, function(html) {
		                    layer.open({
		                        type: 1,
		                        title: '表单',
		                        content: html,
		                        area: ['800px', '450px'],
		                        btn: ['提交', '重置', '取消'],
		                        yes: function(index, layero) {
		                            editIndex = index;
		                            $('form[lay-filter="form-edit"]').find('button[lay-submit]').click();
		                        },
		                        btn2: function(index, layero) {
		                            $('form[lay-filter="form-edit"]').find('button[type="reset"]').click();
		                            return false;
		                        },
		                        success: function() {
		                            form.render(null, 'form-edit');
		                        }
		                    });
		                    upload.render({
            	                elem: '#fileBtn'
            	                ,url: '../../drug/upload.action'
            	                ,accept: 'file'
            	                ,auto: false
            	                ,bindAction: '#uploadBtn'
            	                ,done: function(res){
            	                	layer.msg(res.msg);
            	                	if (res.status=="1") {
            	                		 $("[name=drugPictrue]").val(res.obj);
            	                		 $("#fileBtn").html('<i class="layui-icon">&#xe67c;</i>选择文件');
            	                		 form.render('form-edit');
            	                	}
            	                   
            	                }
            	            });
		                });
		                //同步更新缓存对应的值
		                // obj.update({
		                //     username: '123',
		                //     title: 'xxx'
		                // });
		            }
		        });
		        form.render(null, 'kit-search-form');
		        $('#kit-search-more').on('click', function() {
		            $('.kit-search-mored').toggle();
		        });
		        var editIndex;
		        form.on('submit(formEdit)', function(data) {
                	if ($("[name=drugPictrue]").val()=="") {
                		layer.msg('未上传文件');
                    	$("#fileBtn").html('<span style="color:red"><i class="layui-icon">&#xe67c;</i>选择文件</span>');
                    	form.render(null, 'form-edit');
                    	return false;
                    }
                	$.ajax({ url:"../../drug/addDrug.action",
                        type:'post',//method请求方式，get或者post
                        cache: false,//同步
                        dataType:'json',//预期服务器返回的数据类型
                        data:JSON.stringify(data.field),//表格数据序列化
                        contentType: "application/json; charset=utf-8",
                        success:function(mes){//res为相应体,function为回调函数
                        	$(".layui-laypage-btn")[0].click();//当前表格刷新
	                        if(mes.status==1){ 
		                        $("#res").click();//调用重置按钮将表单数据清空
		                        editIndex && layer.close(editIndex); //关闭弹出层
	                        	layer.msg(mes.msg,{icon:1});
	                        } else {
	                        	layer.msg(mes.msg,{icon:5});
	                        }
                        },
                       	error:function(){layer.alert('操作失败！！！',{icon:5});}
	                 });
                	return false;
		        });
		        $('.kit-search-btns').children('a').off('click').on('click', function() {
		            var $that = $(this),
		                action = $that.data('action');
		            switch (action) {
		                case 'add':
		                    var d = {
		                        rowdata: {
		                        	drugId: '',
		                            drugName: '',
		                            drugProp: 1,
		                            drugUnit: '',
		                            drugPrice: '',
		                            drugPictrue: ''
		                        },
		                        types: staticData.types
		                    };
		                    //渲染
		                    laytpl($('#edit-tpl').html()).render(d,
		                        function(html) {
		                            layer.open({
		                                type: 1,
		                                title: '表单',
		                                content: html,
		                                area: ['800px', '430px'],
		                                btn: ['提交', '重置', '取消'],
		                                yes: function(index, layero) {
		                                    editIndex = index;
		                                    $('form[lay-filter="form-edit"]').find('button[lay-submit]').click();
		                                },
		                                btn2: function(index, layero) {
		                                    $('form[lay-filter="form-edit"]').find('button[type="reset"]').click();
		                                    return false;
		                                },
		                                success: function() {
		                                    form.render(null, 'form-edit');
		                                }
		                            });
		                            upload.render({
		            	                elem: '#fileBtn'
		            	                ,url: '../../drug/upload.action'
		            	                ,accept: 'file'
		            	                ,auto: false
		            	                ,bindAction: '#uploadBtn'
		            	                ,done: function(res){
		            	                	layer.msg(res.msg);
		            	                	if (res.status=="1") {
		            	                		 $("[name=drugPictrue]").val(res.obj);
		            	                		 $("#fileBtn").html('<i class="layui-icon">&#xe67c;</i>选择文件');
		            	                		 form.render(null, 'form-edit');
		            	                	}
		            	                   
		            	                }
		            	            });
		                        });
		                    break;
		                case 'del-bulk':
		                    var d = table.checkStatus('demo');
		                    if (d.data.length === 0) {
		                        layer.msg('请选择要删除的数据');
		                        return;
		                    }
		                    var data = d.data,
		                        names = [],
		                        ids = [];
		                    layui.each(data, function(index, item) {
		                        names.push(item.drugName);
		                        ids.push(item.drugId);
		                    });
		                    /* $.post("../../drug/bulkUpdate.action",JSON.stringify({"ids":ids}),function(mes){ 
		                    	if(mes.status=="1"){
		                    		layer.msg(mes.msg,{icon:1});
		                    	}else{ 
		                    		layer.msg(mes.msg,{icon:5});
		                    	}
		                    }); */
		                    $.ajax({ url:"../../drug/bulkUpdate.action",
		                        type:'post',//method请求方式，get或者post
		                        cache: false,//同步
		                        dataType:'json',//预期服务器返回的数据类型
		                        data:JSON.stringify({"ids":ids}),//表格数据序列化
		                        contentType: "application/json; charset=utf-8",
		                        success:function(mes){//res为相应体,function为回调函数
		                        	$(".layui-laypage-btn")[0].click();//当前表格刷新
		                        	if(mes.status=="1"){
			                    		layer.msg(mes.msg,{icon:1});
			                    	}else{ 
			                    		layer.msg(mes.msg,{icon:5});
			                    	}
		                        },
		                       	error:function(){layer.alert('操作失败！！！',{icon:5});}
			                 });
		                    break;
		            }
		        });
		    });
		</script>
	</body>
</html>
