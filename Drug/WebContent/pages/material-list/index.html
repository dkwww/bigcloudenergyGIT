<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="renderer" content="webkit" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="format-detection" content="telephone=no" />
		<title>原料清单</title>
		<link rel="stylesheet" href="../../res/layui/css/layui.css" />
		<script src="../../res/js/common/jquery-1.11.2.min.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="../../res/css/material-list/index.css" />
		<script src="../../res/js/material-list/index.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="../../res/css/material-list/row.css" />
		<style>
		
		</style>
	</head>
	<body class="childBody">
		<section class="layui-col-md10">
			<div class="layui-card">
				<div class="card-top css-transition">
					<div class="layui-card-header">
						<h3>药品：<font style="color: #DC2D00;">珍视明滴眼液</font>
						</h3>
					</div>
					<div class="layui-card-body layui-text">
						<div id="toolbar">
							<div>
								<button type="button" class="layui-btn layui-btn-sm add" title="筛选原材料">
									<i class="layui-icon layui-icon-add-1"></i> 添加原材料
								</button>
								<button type="button" class="layui-btn layui-btn-sm layui-btn-danger" data-type="delBulk" title="批量删除">
									<i class="layui-icon">&#xe640;</i> 批量删除
								</button>
							</div>
						</div>
						<div id="tableRes" class="table-overlay">
							<table id="dataTable1" lay-filter="dataTable" class="layui-hide"></table>
						</div>
						<div id="action" class="text-center">
							<button type="button" name="btnSave" class="layui-btn" data-type="save"><i class="layui-icon layui-icon-ok-circle"></i>保存</button>
							<button type="reset" name="btnReset" class="layui-btn layui-btn-primary">取消</button>
						</div>
					</div>
				</div>

				<div class="card-down css-transition">
					<div class="layui-card-header layui-form" style="padding: 8px 0px;">
						<!-- 搜索扩展工具条 -->
						<form class="layui-form" lay-filter="kit-search-form">
						<div class="layui-form-item">
							<label class="layui-form-label" style="padding: 9px 10px;width: 58px;">药材筛选</label>
							<div style="width: 200px;margin-left: 85px;">
								<select name="mtName" lay-filter="mat-type" id="mat-type">
									<option value=""></option>
								</select>
							</div>
						</div>
						</form>
					</div>
					<div class="layui-card-body">
						<div id="tableRes" class="table-overlay">
							<div class="card-body-left">
								<div class="scroll-wrap">
									<ul class="down-ul">
										<p class="li-title">药材清单（list）</p>
										<li>山药</li>
										<li>人参</li>
										<li>枸杞</li>
									</ul>
								</div>
							</div>
							<div class="card-body-right">
								<table id="dataTable2" lay-filter="dataTables" class="layui-hide" ></table>
							</div>
						</div>
						<div id="action" class="text-center">
							<button type="button" name="btnConfirm" class="layui-btn btnConfirm" data-type="confirm"><i class="layui-icon layui-icon-ok-circle"></i>确定</button>
							<button type="reset" name="btnCancel" class="layui-btn layui-btn-primary">取消</button>
						</div>
					</div>
				</div>
			</div>
			<!--保存结果输出-->
			<div class="layui-card">
				<div class="layui-card-header">保存结果输出</div>
				<div class="layui-card-body layui-text">
					<blockquote class="layui-elem-quote layui-quote-nm">
						<pre id="jsonResult"><span class="layui-word-aux">请点击“保存”后查看输出信息……</span></pre>
					</blockquote>
				</div>
			</div>
		</section>
		<!--recommended script position-->
		<script src="../../res/layui/layui.all.js"></script>
		<script type="text/javascript">
			//准备视图对象
			window.viewObj = null;
			$.ajax({
				url: "../../materialList/showList.action", //json文件位置
				data: {"page":1,"limit":1000},
				type: "post",
				async: false,
				dataType: "json", //返回数据格式为json
				success: function(data) { //请求成功完成后要执行的方法
					viewObj = data;
				}
			});
			var arr1 = new Array();//选中的数据
			var arr2 = new Array();//表格的数据
			var tableData = new Array();//第一个表格的数据
			//layui 模块化引用
			layui.use(['table', 'layer', 'element', 'jquery', 'form'], function(table, layer, element, $, form) {
				// data模式
				var $ = layui.$, table = layui.table, form = layui.form, layer = layui.layer;
				
				//数据表格实例化			
				var layTableId1 = "layTableId1";
				var tableIns = table.render({
					elem: '#dataTable1',
					id: layTableId1,
					data: viewObj.data,
					height: autoHeight(layTableId1),
					page: true,
					loading: true,
					cols: [
							[{checkbox: true},{title: '序号',type: 'numbers'},
							{field: 'matName',title: '材料名称（name）'},
							{field: 'mlAmount',title: '数量（amount）',edit: 'number'},
							{field: 'matPrice',title: '单价（price）'},
							{field: 'mtName',title: '种类（type）'},
							{field: 'matEffect',title: '功效（effect）'},
							{field: 'tempId',title: '操作',
								templet: function(d) {
									return '<a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del" lay-id="' + d.tempId +
										'"><i class="layui-icon layui-icon-delete"></i>移除</a>';
								}
							}
						]
					],
					done: function(res, curr, count) {
						tableData = res.data;
						$("[data-field = 'mlAmount']").keyup(function() {
							var obj = $(this).children().last();
							if (obj.prop('maxlength') == -1) {
								obj.prop('maxlength', 5);
							}
							obj.val(obj.val().replace(/[^0-9]*$/, ""));
							obj.val(obj.val().replace(/^[0]+[0-9]*$/gi, ""));
						});
					}
				});
				
				//定义事件集合
				var active = {
					add: function() { 
					},
					removeEmptyTableCache: function() {
						var oldData = table.cache[layTableId1];
						for (var i = 0, row; i < oldData.length; i++) {
							row = oldData[i];
							if (!row || !row.tempId) {
								oldData.splice(i, 1); //删除一项
							}
							continue;
						}
						tableIns.reload({
							data: oldData
						});
					},
					delBulk: function() {
						var d = table.checkStatus(layTableId1);
						if (d.data.length === 0) {
							layer.msg('请选择要删除的数据');
							return;
						}
						var data = d.data,
							names = [],
							ids = [];
						layui.each(data, function(index, item) {
							console.log(item);
							names.push(item.username);
							ids.push(item.id);
						});
						layer.msg(names.join(','));
						console.log(ids.join(','));
					},
					save: function() {
						var oldData = table.cache[layTableId1];
						console.log(oldData);
						for (var i = 0, row; i < oldData.length; i++) {
							row = oldData[i];
						}
						document.getElementById("jsonResult").innerHTML = JSON.stringify(table.cache[layTableId1], null, 2); //使用JSON.stringify() 格式化输出JSON字符串	
					},
					confirm: function() {
						tableData = table.cache[layTableId1];
						for (var i=0;i<arr1.length;i++) {
							console.log(arr1[i])
							tableData.unshift(arr1[i]);
						};
						tableIns.reload({
							data: tableData
						});
					}
				}

				//激活事件
				var activeByType = function(type, arg) {
					if (arguments.length === 2) {
						active[type] ? active[type].call(this, arg) : '';
					} else {
						active[type] ? active[type].call(this) : '';
					}
				}

				//注册按钮事件
				$('.layui-btn[data-type]').on('click', function() {
					var type = $(this).data('type');
					activeByType(type);
				});

				//监听工具条
				table.on('tool(dataTable)', function(obj) {
					var data = obj.data,
						event = obj.event,
						tr = obj.tr; //获得当前行 tr 的DOM对象;
					console.log(data);
					switch (event) {
						case "del":
							layer.confirm('真的删除行么？', function(index) {
								obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
								layer.close(index);
								activeByType('removeEmptyTableCache');
							});
							break;
					}
				});

				
				
				
				var layTableId2 = "table2";
				var h2 = autoHeight(layTableId2);
				var tableElem = "";
				var tableIns = table.render({
					elem: '#dataTable2',
					id: layTableId2,
					height: h2,
					url: "../../material/showList.action",
					page: true,
					cols: [
						[ //表头
							{
								type: 'checkbox',
								fixed: true
							},
							{title: '序号',type: 'numbers'},
							{field: 'matId',title: '材料编号（ID）'},
							{field: 'matName',title: '材料名称（name）'},
							{field: 'matAmount',title: '数量（amount）'},
							{field: 'matPrice',title: '单价（price）'},
							{field: 'mtName',title: '种类（type）'},
							{field: 'matEffect',title: '功效（effect）'}
						]
					],
					done: function(res, curr, count) {
						tableElem = this.elem.next('.layui-table-view');
						count || tableElem.find('.layui-table-header').css('overflow', 'auto');
						layui.each(table.cache[layTableId2], function(index, data) {
							for (var j = 0; j < arr1.length; j++) {
								if (res.data[index].matId == arr1[j].matId) {
									res.data[index]["LAY_CHECKED"] = true;
									tableElem.find('tr[data-index=' + index + '] input[type="checkbox"]').prop('checked', true).next().addClass('layui-form-checked');
								}
							}
						});
						var checkStatus = table.checkStatus(layTableId2);
						if (checkStatus.isAll) {
							tableElem.find('th[data-field="0"] input[type="checkbox"]').prop('checked', true).next().addClass('layui-form-checked');
						}
						layui.each(table.cache[layTableId2], function(index, data) {
							for (var i = 0; i < tableData.length; i++) {
								if (tableData[i].matId == data.matId) {
									res.data[index]["LAY_CHECKED"] = false;
									tableElem.find('tr[data-index="' + index + '"]').find('input[name="layTableCheckbox"]').attr({
										name: 'layTableCheckbox_disabled',
										disabled: 'disabled'
									});
									res.data[index].checkDisabled = true;
									return;
								} else {
									res.data[index].checkDisabled = false;
								}
							}
						});
						console.log(table.cache[layTableId2])
						form.render();
					}
				});
				$(".layui-card").css({"height":h2+150});
				$(".card-body-left").css({"height":h2});
				table.on('checkbox(dataTables)', function(obj) {
					if (obj.checked == true) {
						if (obj.type == 'one') {
							addRow(obj.data);
							arr1.push(obj.data);
							arr1[arr1.length-1]['state']=0;
						} else {
							arr2 = table.cache[layTableId2];
							console.log(arr2);
							console.log(arr1);
							for (var i = 0; i < arr2.length; i++) {
								var stra = ;
								var disabled = arr2[i].checkDisabled;
								var count = 0;
								for (var j = 0; j < arr1.length; j++) {
									if ((arr2[i].matId == arr1[j].matId)&&disabled) {
										count++;
									}
								}
								if (count === 0) {
									addRow(arr2[i]);
									arr2[i]['state']=0;
									arr1.push(arr2[i])
								}
							}
							arr3 = arr1;
							console.log(arr3);
						}
					} else {
						if (obj.type == 'one') {
							removeOne(obj.data.matId);
						} else {
							arr2 = table.cache[layTableId2];
							for (var i = 0; i < arr2.length; i++) {
								removeOne(arr2[i].matId);
							}
						}
					}
					console.log(arr1)
				});
				//查询类型下拉框数据
		        $.ajax({ 
		        	url:'../../matType/showList.action',
                    type:'post',//method请求方式，get或者post
                    cache: false,//同步
                    dataType:'json',//预期服务器返回的数据类型
                    success:function(mes){//res为相应体,function为回调函数
                    	//循环添加类型搜索框内的数据
                    	$.each(mes.data,function(index,item){
                    		$("#mat-type").append("<option value="+item.mtName+">"+item.mtName+"</option>");
                    	});
                    	//渲染类型搜索框内的下拉框
                    	renderForm();
                    }
                 });
				form.on('select(mat-type)', function(data){
				  	//带条件查询
		            tableIns.reload({
		                where: {"mtName":data.value},
		                page: { curr: 1 }
		            });
				})
				//重新渲染表单
			  	function renderForm(){ 
		  			layui.use('form', function(){ 
			  			var form = layui.form;//高版本建议把括号去掉，有的低版本，需要加() 
			  			form.render(); 
		  			}); 
		  		}
				
				//窗口自适应
				function autoHeight(tableId){
					var h = document.body.clientHeight && document.documentElement.clientHeight - 232; //窗口高度
					//监听改变窗口大小
					/* window.onresize = function() {
						h = document.body.clientHeight && document.documentElement.clientHeight - 232; //窗口高度
						tableIns2.reload(tableId, {
							height: h
						}); //刷新数据表格
						//window.location.reload(); //刷新iframe页面
					} */
					return h;
				}
				
				//移除数组内重复的元素
				function removeOne(arrId) {
					var arr3 = new Array();
					for (var i = 0; i < arr1.length; i++) {
						if (arr1[i].matId == arrId) {
							removeRow(arr1[i].matId);
						} else {
							arr3.push(arr1[i]);
						}
					}
					arr1 = arr3;
				}
				
				function changeState(rowId) {
					var objStr = tableElem.find("td[data-field='matId']");
					for (var i = 0; i < objStr.length; i++) {
						if (objStr[i].innerText == rowId) {
							tableElem.children().find('.layui-table-fixed input[type="checkbox"]').eq(i+1).next().click();
							tableElem.find('.layui-table-fixed input[type="checkbox"]').eq(i+1).next().removeClass('layui-form-checked');
						}
					}
				}
				
				function addClose(obj) {
					obj.append("<span class='li-close'>×</span>");
					obj.find(".li-close").on("click", function() {
						changeState(obj.prop("id"));
						removeOne(obj.prop("id"));
					});
				}

				function addRow(data) {
					$("<li />", {
						'id': data.matId,
						'text': data.matName,
						'class': "new-item "
					}).insertAfter($(".li-title"));
					addClose($("#" + data.matId));
				}
				
				function removeRow(id) {
					var removePoint = $(".down-ul").find("#" + id);
					removePoint.removeClass("new-item").addClass("remove-item");
					setTimeout(function() {
						$(".remove-item").remove();
					}, 480);
				}
			});
		</script>
		<script>
			
		</script>
	</body>
</html>
